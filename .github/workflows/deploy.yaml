name: AtlaSent Deploy Gate

on:
  push:
    branches: [main]
  workflow_dispatch: {}

jobs:
  atlasent-deploy-gate:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install jq (required)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Evaluate with AtlaSent (DEBUG MODE)
        id: eval
        env:
          ATLASENT_API_KEY: ${{ secrets.ATLASENT_API_KEY }}
          ATLASENT_BASE_URL: https://ducfnmhveikymmgwpgcd.supabase.co/functions/v1
        run: |
          set -euo pipefail

          echo "ATLASENT_BASE_URL=${ATLASENT_BASE_URL}"

          if [ -z "${ATLASENT_API_KEY:-}" ]; then
            echo "::error::ATLASENT_API_KEY secret is not set"
            exit 1
          fi

          REQUEST_ID="github-eval-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"

          BODY=$(jq -nc \
            --arg action_type "production.deploy" \
            --arg actor_id "github:${GITHUB_ACTOR}" \
            --arg request_id "$REQUEST_ID" \
            --arg env "prod" \
            --arg repo "${GITHUB_REPOSITORY}" \
            --arg sha "${GITHUB_SHA}" \
            --arg ref "${GITHUB_REF}" \
            --arg run_id "${GITHUB_RUN_ID}" \
            --argjson approvals 2 \
            --argjson change_window true \
            '{
              action_type: $action_type,
              actor_id: $actor_id,
              request_id: $request_id,
              context: {
                environment: $env,
                approvals: $approvals,
                change_window: $change_window,
                repo: $repo,
                sha: $sha,
                ref: $ref,
                run_id: $run_id
              }
            }')

          echo "---- Evaluate request body ----"
          echo "$BODY" | jq .
          echo "--------------------------------"

          RESPONSE=$(curl -sS -i --max-time 30 \
            -X POST "${ATLASENT_BASE_URL}/v1-evaluate" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${ATLASENT_API_KEY}" \
            -d "${BODY}")

          echo "---- Evaluate raw response ----"
          echo "$RESPONSE"
          echo "--------------------------------"

          HTTP_CODE=$(echo "$RESPONSE" | head -n 1 | awk '{print $2}')
          if [ "$HTTP_CODE" != "200" ] && [ "$HTTP_CODE" != "201" ] && [ "$HTTP_CODE" != "204" ]; then
            echo "::error::Evaluate returned HTTP $HTTP_CODE — BLOCKED (fail-closed)"
            exit 1
          fi

          JSON=$(echo "$RESPONSE" | awk 'BEGIN{h=1} /^\r?$/{h=0; next} {if(!h) print}')

          DECISION=$(echo "$JSON" | jq -r '.decision // empty')
          if [ "$DECISION" != "allow" ]; then
            CODE=$(echo "$JSON" | jq -r '.error_code // .deny_code // "unknown"')
            REASON=$(echo "$JSON" | jq -r '.reason // .deny_reason // "no reason provided"')
            echo "::error::BLOCKED by AtlaSent evaluate decision=$DECISION code=$CODE reason=$REASON"
            exit 1
          fi

          PERMIT_TOKEN=$(echo "$JSON" | jq -r '.permit_token // .permit // empty')
          if [ -z "$PERMIT_TOKEN" ] || [ "$PERMIT_TOKEN" = "null" ]; then
            echo "::error::Allowed but missing permit_token — BLOCKED"
            exit 1
          fi

          echo "PERMIT_TOKEN=$PERMIT_TOKEN" >> $GITHUB_ENV

      - name: Verify permit (DEBUG MODE)
        env:
          ATLASENT_API_KEY: ${{ secrets.ATLASENT_API_KEY }}
          ATLASENT_BASE_URL: https://ducfnmhveikymmgwpgcd.supabase.co/functions/v1
        run: |
          set -euo pipefail

          if [ -z "${PERMIT_TOKEN:-}" ]; then
            echo "::error::Missing PERMIT_TOKEN from evaluate step — deploy BLOCKED"
            exit 1
          fi
          VERIFY_ID="github-verify-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"

          BODY=$(jq -nc \
            --arg permit_token "${PERMIT_TOKEN}" \
            --arg action_type "production.deploy" \
            --arg actor_id "github:${GITHUB_ACTOR}" \
            --arg environment "prod" \
            --arg request_id "${VERIFY_ID}" \
            --arg env "prod" \
            --arg repo "${GITHUB_REPOSITORY}" \
            --arg sha "${GITHUB_SHA}" \
            --arg ref "${GITHUB_REF}" \
            --arg run_id "${GITHUB_RUN_ID}" \
            --argjson approvals 2 \
            --argjson change_window true \
            '{
              permit_token: $permit_token,
              action_type: $action_type,
              actor_id: $actor_id,
              environment: $environment,
              request_id: $request_id,
              context: {
                environment: $env,
                approvals: $approvals,
                change_window: $change_window,
                repo: $repo,
                sha: $sha,
                ref: $ref,
                run_id: $run_id
              }
            }')

          echo "---- Verify request body ----"
          echo "$BODY" | jq .
          echo "------------------------------"

          RESPONSE=$(curl -sS -i --max-time 30 \
            -X POST "${ATLASENT_BASE_URL}/v1-verify-permit" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${ATLASENT_API_KEY}" \
            -d "${BODY}")

          echo "---- Verify raw response ----"
          echo "$RESPONSE"
          echo "--------------------------------"

          HTTP_CODE=$(echo "$RESPONSE" | head -n 1 | awk '{print $2}')
          if [ "$HTTP_CODE" != "200" ] && [ "$HTTP_CODE" != "201" ] && [ "$HTTP_CODE" != "204" ]; then
            echo "::error::Verify returned HTTP $HTTP_CODE — BLOCKED (fail-closed)"
            exit 1
          fi

          JSON=$(echo "$RESPONSE" | awk 'BEGIN{h=1} /^\r?$/{h=0; next} {if(!h) print}')

          OUTCOME=$(echo "$JSON" | jq -r '.outcome // .decision // empty')
          if [ "$OUTCOME" != "allow" ]; then
            CODE=$(echo "$JSON" | jq -r '.verify_error_code // .deny_code // "unknown"')
            REASON=$(echo "$JSON" | jq -r '.reason // .deny_reason // "unknown"')
            echo "::error::Permit verification FAILED outcome=$OUTCOME code=$CODE reason=$REASON"
            exit 1
          fi

          echo "✅ Permit verified — deploy may proceed"

      - name: Deploy to Production (placeholder)
        run: |
          echo "Replace this with your real deploy command"

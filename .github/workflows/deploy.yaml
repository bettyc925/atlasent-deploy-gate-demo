name: AtlaSent Deploy Gate

on:
  push:
    branches: [main]
  workflow_dispatch: {}

jobs:
  atlasent-deploy-gate:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install jq (required)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Evaluate with AtlaSent (must ALLOW)
        id: eval
        env:
          ATLASENT_API_KEY: ${{ secrets.ATLASENT_API_KEY }}
          ATLASENT_BASE_URL: https://ducfnmhveikymmgwpgcd.supabase.co/functions/v1
        run: |
          set -euo pipefail

          if [ -z "${ATLASENT_API_KEY:-}" ]; then
            echo "::error::ATLASENT_API_KEY secret is not set"
            exit 1
          fi

          REQUEST_ID="github-eval-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"

          BODY=$(jq -nc \
            --arg action_type "production.deploy" \
            --arg actor_id "github:${GITHUB_ACTOR}" \
            --arg request_id "$REQUEST_ID" \
            --arg env "prod" \
            --arg repo "${GITHUB_REPOSITORY}" \
            --arg sha "${GITHUB_SHA}" \
            --arg ref "${GITHUB_REF}" \
            --arg run_id "${GITHUB_RUN_ID}" \
            '{
              action_type: $action_type,
              actor_id: $actor_id,
              request_id: $request_id,
              context: {
                environment: $env,
                repo: $repo,
                sha: $sha,
                ref: $ref,
                run_id: $run_id
              }
            }')

          RESPONSE=$(curl -sS --fail-with-body --max-time 30 \
            -X POST "${ATLASENT_BASE_URL}/v1-evaluate" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${ATLASENT_API_KEY}" \
            -d "${BODY}") || {
              echo "::error::AtlaSent evaluate unreachable or non-2xx — BLOCKED (fail-closed)"
              exit 1
            }

          echo "Evaluate response: $RESPONSE"
          echo "$RESPONSE" | jq . >/dev/null 2>&1 || {
            echo "::error::AtlaSent evaluate returned invalid JSON — BLOCKED (fail-closed)"
            exit 1
          }

          DECISION=$(echo "$RESPONSE" | jq -r '.decision // empty')
          if [ -z "$DECISION" ]; then
            echo "::error::Missing decision — BLOCKED (fail-closed)"
            exit 1
          fi

          if [ "$DECISION" != "allow" ]; then
            CODE=$(echo "$RESPONSE" | jq -r '.error_code // .deny_code // "unknown"')
            REASON=$(echo "$RESPONSE" | jq -r '.reason // .deny_reason // "no reason provided"')
            echo "::error::BLOCKED by AtlaSent evaluate decision=$DECISION code=$CODE reason=$REASON"
            exit 1
          fi

          PERMIT_TOKEN=$(echo "$RESPONSE" | jq -r '.permit_token // .permit // empty')
          if [ -z "$PERMIT_TOKEN" ] || [ "$PERMIT_TOKEN" = "null" ]; then
            echo "::error::Allowed but missing permit_token — BLOCKED (fail-closed)"
            exit 1
          fi

          echo "PERMIT_TOKEN=$PERMIT_TOKEN" >> $GITHUB_ENV

      - name: Verify permit (execution-time enforcement) (must ALLOW)
        env:
          ATLASENT_API_KEY: ${{ secrets.ATLASENT_API_KEY }}
          ATLASENT_BASE_URL: https://ducfnmhveikymmgwpgcd.supabase.co/functions/v1
        run: |
          set -euo pipefail

          if [ -z "${PERMIT_TOKEN:-}" ]; then
            echo "::error::Missing PERMIT_TOKEN — BLOCKED"
            exit 1
          fi

          VERIFY_ID="github-verify-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"

          BODY=$(jq -nc \
            --arg permit_token "${PERMIT_TOKEN}" \
            --arg action_type "production.deploy" \
            --arg actor_id "github:${GITHUB_ACTOR}" \
            --arg environment "prod" \
            --arg request_id "${VERIFY_ID}" \
            --arg env "prod" \
            --arg repo "${GITHUB_REPOSITORY}" \
            --arg sha "${GITHUB_SHA}" \
            --arg ref "${GITHUB_REF}" \
            --arg run_id "${GITHUB_RUN_ID}" \
            '{
              permit_token: $permit_token,
              action_type: $action_type,
              actor_id: $actor_id,
              environment: $environment,
              request_id: $request_id,
              context: {
                environment: $env,
                repo: $repo,
                sha: $sha,
                ref: $ref,
                run_id: $run_id
              }
            }')

          RESPONSE=$(curl -sS --fail-with-body --max-time 30 \
            -X POST "${ATLASENT_BASE_URL}/v1-verify-permit" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${ATLASENT_API_KEY}" \
            -d "${BODY}") || {
              echo "::error::AtlaSent verify unreachable or non-2xx — BLOCKED (fail-closed)"
              exit 1
            }

          echo "Verify response: $RESPONSE"
          echo "$RESPONSE" | jq . >/dev/null 2>&1 || {
            echo "::error::AtlaSent verify returned invalid JSON — BLOCKED (fail-closed)"
            exit 1
          }

          OUTCOME=$(echo "$RESPONSE" | jq -r '.outcome // .decision // empty')
          VALID=$(echo "$RESPONSE" | jq -r '.valid // empty')

          if [ -n "$VALID" ] && [ "$VALID" != "true" ]; then
            CODE=$(echo "$RESPONSE" | jq -r '.verify_error_code // .deny_code // "unknown"')
            REASON=$(echo "$RESPONSE" | jq -r '.reason // .deny_reason // "unknown"')
            echo "::error::Permit invalid — code=$CODE reason=$REASON"
            exit 1
          fi

          if [ -z "$OUTCOME" ]; then
            echo "::error::Missing outcome/decision from verify — BLOCKED (fail-closed)"
            exit 1
          fi

          if [ "$OUTCOME" != "allow" ]; then
            CODE=$(echo "$RESPONSE" | jq -r '.verify_error_code // .deny_code // "unknown"')
            REASON=$(echo "$RESPONSE" | jq -r '.reason // .deny_reason // "unknown"')
            echo "::error::Permit verification FAILED — outcome=$OUTCOME code=$CODE reason=$REASON"
            exit 1
          fi

          echo "✅ Permit verified — deploy may proceed"

      - name: Deploy to Production (placeholder)
        run: |
          echo "✅ Replace this with your deploy command"

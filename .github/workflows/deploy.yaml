name: Deploy (AtlaSent Gate)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Evaluate with AtlaSent
        env:
          ATLASENT_BASE_URL: ${{ secrets.ATLASENT_BASE_URL }}
          ATLASENT_API_KEY: ${{ secrets.ATLASENT_API_KEY }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          set -e

          RESPONSE=$(curl -s -X POST "${ATLASENT_BASE_URL}/v1-evaluate" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${ATLASENT_API_KEY}" \
            -H "apikey: ${SUPABASE_ANON_KEY}" \
            -d "{
              \"action_type\": \"production.deploy\",
              \"actor_id\": \"agent:ci\",
              \"request_id\": \"gha-${GITHUB_RUN_ID}\",
              \"context\": {
                \"environment\": \"test\",
                \"approvals\": 2,
                \"change_window\": true
              }
            }")

          echo "Response: $RESPONSE"

          DECISION=$(echo "$RESPONSE" | jq -r '.decision')

          if [ "$DECISION" != "allow" ]; then
            echo "Deploy denied"
            exit 1
          fi

      - name: Deploy (placeholder)
        run: echo "Deploy would run here"

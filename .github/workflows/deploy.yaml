name: AtlaSent Deploy Gate

on:
  push:
    branches: [main]
  workflow_dispatch: {}

jobs:
  atlasent-deploy-gate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq (required)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Compute artifact fingerprint
        id: fp
        run: |
          echo "artifact_hash=${GITHUB_SHA}" >> $GITHUB_OUTPUT

      - name: Evaluate with AtlaSent (must ALLOW)
        id: eval
        env:
          ATLASENT_API_KEY: ${{ secrets.ATLASENT_API_KEY }}
          ATLASENT_BASE_URL: https://YOUR_PROJECT_REF.supabase.co/functions/v1
          ARTIFACT_HASH: ${{ steps.fp.outputs.artifact_hash }}
        run: |
          set -euo pipefail

          if [ -z "${ATLASENT_API_KEY:-}" ]; then
            echo "ERROR: Missing secret ATLASENT_API_KEY. Failing closed."
            exit 1
          fi

          RESPONSE=$(curl -sS --fail-with-body -X POST "${ATLASENT_BASE_URL}/v1-evaluate" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${ATLASENT_API_KEY}" \
            -d "{
              \"action_type\": \"deployment.production\",
              \"actor_id\": \"github:${GITHUB_ACTOR}\",
              \"request_id\": \"gha-eval-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}\",
              \"context\": {
                \"environment\": \"production\",
                \"repo\": \"${GITHUB_REPOSITORY}\",
                \"sha\": \"${GITHUB_SHA}\",
                \"ref\": \"${GITHUB_REF}\",
                \"run_id\": \"${GITHUB_RUN_ID}\",
                \"artifact_hash\": \"${ARTIFACT_HASH}\"
              }
            }")

          echo "Evaluate response: $RESPONSE"

          DECISION=$(echo "$RESPONSE" | jq -r '.decision // empty')
          DENY_REASON=$(echo "$RESPONSE" | jq -r '.deny_reason // empty')
          PERMIT_TOKEN=$(echo "$RESPONSE" | jq -r '.permit_token // empty')

          if [ -z "$DECISION" ]; then
            echo "ERROR: Missing decision in evaluate response. Failing closed."
            exit 1
          fi

          if [ "$DECISION" != "allow" ]; then
            echo "BLOCKED by AtlaSent evaluate (decision=$DECISION deny_reason=$DENY_REASON)"
            exit 1
          fi

          if [ -z "$PERMIT_TOKEN" ] || [ "$PERMIT_TOKEN" = "null" ]; then
            echo "ERROR: decision=allow but missing permit_token. Failing closed."
            exit 1
          fi

          echo "permit_token=$PERMIT_TOKEN" >> $GITHUB_OUTPUT

      - name: Verify permit (execution-time enforcement)
        id: verify
        env:
          ATLASENT_API_KEY: ${{ secrets.ATLASENT_API_KEY }}
          ATLASENT_BASE_URL: https://YOUR_PROJECT_REF.supabase.co/functions/v1
          ARTIFACT_HASH: ${{ steps.fp.outputs.artifact_hash }}
          PERMIT_TOKEN: ${{ steps.eval.outputs.permit_token }}
        run: |
          set -euo pipefail

          if [ -z "${PERMIT_TOKEN:-}" ]; then
            echo "ERROR: Missing permit_token from evaluate. Failing closed."
            exit 1
          fi

          VERIFY_RESPONSE=$(curl -sS --fail-with-body -X POST "${ATLASENT_BASE_URL}/v1-verify-permit" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${ATLASENT_API_KEY}" \
            -d "{
              \"permit_token\": \"${PERMIT_TOKEN}\",
              \"action_type\": \"deployment.production\",
              \"actor_id\": \"github:${GITHUB_ACTOR}\",
              \"environment\": \"production\",
              \"request_id\": \"gha-verify-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}\",
              \"context\": {
                \"environment\": \"production\",
                \"repo\": \"${GITHUB_REPOSITORY}\",
                \"sha\": \"${GITHUB_SHA}\",
                \"ref\": \"${GITHUB_REF}\",
                \"run_id\": \"${GITHUB_RUN_ID}\",
                \"artifact_hash\": \"${ARTIFACT_HASH}\"
              }
            }")

          echo "Verify response: $VERIFY_RESPONSE"

          OUTCOME=$(echo "$VERIFY_RESPONSE" | jq -r '.outcome // .decision // empty')
          if [ -z "$OUTCOME" ]; then
            echo "ERROR: Missing outcome in verify response. Failing closed."
            exit 1
          fi

          if [ "$OUTCOME" != "allow" ]; then
            echo "BLOCKED by AtlaSent verify (outcome=$OUTCOME)"
            exit 1
          fi

      - name: Deploy (placeholder)
        run: |
          echo "✅ Deploy would run now"
          echo "Commit: $GITHUB_SHA"

  atlasent-replay-protection:
    runs-on: ubuntu-latest
    needs: atlasent-deploy-gate

    steps:
      - name: Install jq (required)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Compute artifact fingerprint
        id: fp
        run: |
          echo "artifact_hash=${GITHUB_SHA}" >> $GITHUB_OUTPUT

      - name: Evaluate (new permit)
        id: eval
        env:
          ATLASENT_API_KEY: ${{ secrets.ATLASENT_API_KEY }}
          ATLASENT_BASE_URL: https://YOUR_PROJECT_REF.supabase.co/functions/v1
          ARTIFACT_HASH: ${{ steps.fp.outputs.artifact_hash }}
        run: |
          set -euo pipefail

          RESPONSE=$(curl -sS --fail-with-body -X POST "${ATLASENT_BASE_URL}/v1-evaluate" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${ATLASENT_API_KEY}" \
            -d "{
              \"action_type\": \"deployment.production\",
              \"actor_id\": \"github:${GITHUB_ACTOR}\",
              \"request_id\": \"gha-replay-eval-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}\",
              \"context\": {
                \"environment\": \"production\",
                \"repo\": \"${GITHUB_REPOSITORY}\",
                \"sha\": \"${GITHUB_SHA}\",
                \"ref\": \"${GITHUB_REF}\",
                \"run_id\": \"${GITHUB_RUN_ID}\",
                \"artifact_hash\": \"${ARTIFACT_HASH}\"
              }
            }")

          echo "Replay test evaluate response: $RESPONSE"
          PERMIT_TOKEN=$(echo "$RESPONSE" | jq -r '.permit_token // empty')

          if [ -z "$PERMIT_TOKEN" ] || [ "$PERMIT_TOKEN" = "null" ]; then
            echo "ERROR: Missing permit_token for replay test. Failing closed."
            exit 1
          fi

          echo "permit_token=$PERMIT_TOKEN" >> $GITHUB_OUTPUT

      - name: Verify #1 (should ALLOW)
        env:
          ATLASENT_API_KEY: ${{ secrets.ATLASENT_API_KEY }}
          ATLASENT_BASE_URL: https://YOUR_PROJECT_REF.supabase.co/functions/v1
          PERMIT_TOKEN: ${{ steps.eval.outputs.permit_token }}
        run: |
          set -euo pipefail

          R1=$(curl -sS --fail-with-body -X POST "${ATLASENT_BASE_URL}/v1-verify-permit" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${ATLASENT_API_KEY}" \
            -d "{
              \"permit_token\": \"${PERMIT_TOKEN}\",
              \"action_type\": \"deployment.production\",
              \"actor_id\": \"github:${GITHUB_ACTOR}\",
              \"environment\": \"production\",
              \"request_id\": \"gha-replay-v1-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}\",
              \"context\": { \"environment\": \"production\" }
            }")

          echo "Replay verify #1 response: $R1"
          OUTCOME=$(echo "$R1" | jq -r '.outcome // .decision // empty')

          if [ "$OUTCOME" != "allow" ]; then
            echo "ERROR: Expected verify #1 allow, got: $OUTCOME"
            exit 1
          fi

      - name: Verify #2 with SAME permit (should NOT ALLOW)
        env:
          ATLASENT_API_KEY: ${{ secrets.ATLASENT_API_KEY }}
          ATLASENT_BASE_URL: https://YOUR_PROJECT_REF.supabase.co/functions/v1
          PERMIT_TOKEN: ${{ steps.eval.outputs.permit_token }}
        run: |
          set -euo pipefail

          R2=$(curl -sS --fail-with-body -X POST "${ATLASENT_BASE_URL}/v1-verify-permit" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${ATLASENT_API_KEY}" \
            -d "{
              \"permit_token\": \"${PERMIT_TOKEN}\",
              \"action_type\": \"deployment.production\",
              \"actor_id\": \"github:${GITHUB_ACTOR}\",
              \"environment\": \"production\",
              \"request_id\": \"gha-replay-v2-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}\",
              \"context\": { \"environment\": \"production\" }
            }")

          echo "Replay verify #2 response: $R2"
          OUTCOME=$(echo "$R2" | jq -r '.outcome // .decision // empty')
          IDEMP=$(echo "$R2" | jq -r '.idempotent_replay // empty')

          if [ "$OUTCOME" = "allow" ]; then
            echo "ERROR: Expected verify #2 to NOT allow, but got allow"
            exit 1
          fi

          echo "✅ Replay protection confirmed. outcome=$OUTCOME idempotent_replay=$IDEMP"

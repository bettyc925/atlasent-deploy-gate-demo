name: AtlaSent Deploy Gate

on:
  push:
    branches: [main]
  workflow_dispatch: {}

env:
  # OLD backend (Lovable-managed) — still gates
  ATLASENT_PRIMARY_BASE_URL: https://ducfnmhveikymmgwpgcd.supabase.co/functions/v1

  # NEW backend (your Supabase)
  ATLASENT_SHADOW_BASE_URL: https://ckbcjcxeiswlubvzzhjf.supabase.co/functions/v1

  # Public anon key from GitHub Variable
  ATLASENT_ANON_KEY: ${{ vars.ATLASENT_ANON_KEY }}

jobs:
  atlasent-deploy-gate:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install jq (required)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Build canonical payload
        id: payload
        run: |
          set -euo pipefail
          REQUEST_ID="github-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"

          BODY=$(jq -nc \
            --arg action_type "production.deploy" \
            --arg actor_id "github:${GITHUB_ACTOR}" \
            --arg request_id "$REQUEST_ID" \
            --arg env "prod" \
            --arg repo "${GITHUB_REPOSITORY}" \
            --arg sha "${GITHUB_SHA}" \
            --arg ref "${GITHUB_REF}" \
            --arg run_id "${GITHUB_RUN_ID}" \
            --argjson approvals 2 \
            --argjson change_window true \
            '{
              action_type: $action_type,
              actor_id: $actor_id,
              request_id: $request_id,
              context: {
                environment: $env,
                approvals: $approvals,
                change_window: $change_window,
                repo: $repo,
                sha: $sha,
                ref: $ref,
                run_id: $run_id
              }
            }')

          echo "request_id=$REQUEST_ID" >> $GITHUB_OUTPUT
          echo "body=$BODY" >> $GITHUB_OUTPUT

      # -------------------------
      # PRIMARY (GATING) CALL
      # -------------------------
      - name: Evaluate (PRIMARY — gates)
        id: primary_eval
        env:
          ATLASENT_API_KEY: ${{ secrets.ATLASENT_API_KEY }}
          BODY: ${{ steps.payload.outputs.body }}
        run: |
          set -euo pipefail
          : "${ATLASENT_API_KEY:?Missing secret ATLASENT_API_KEY}"
          : "${ATLASENT_ANON_KEY:?Missing variable ATLASENT_ANON_KEY}"

          RESP=$(curl -sS -i --max-time 30 \
            -X POST "${ATLASENT_PRIMARY_BASE_URL}/v1-evaluate" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${ATLASENT_API_KEY}" \
            -H "apikey: ${ATLASENT_ANON_KEY}" \
            -d "${BODY}")

          echo "---- PRIMARY EVAL RAW ----"
          echo "$RESP"
          echo "--------------------------"

          HTTP_CODE=$(echo "$RESP" | head -n 1 | awk '{print $2}')
          if [ "$HTTP_CODE" != "200" ] && [ "$HTTP_CODE" != "201" ] && [ "$HTTP_CODE" != "204" ]; then
            echo "::error::PRIMARY evaluate HTTP $HTTP_CODE — BLOCKED (fail-closed)"
            exit 1
          fi

          JSON=$(echo "$RESP" | awk 'BEGIN{h=1} /^\r?$/{h=0; next} {if(!h) print}')
          DECISION=$(echo "$JSON" | jq -r '.decision // empty')

          if [ "$DECISION" != "allow" ]; then
            CODE=$(echo "$JSON" | jq -r '.error_code // .deny_code // "unknown"')
            REASON=$(echo "$JSON" | jq -r '.reason // .deny_reason // "no reason provided"')
            echo "::error::PRIMARY blocked decision=$DECISION code=$CODE reason=$REASON"
            exit 1
          fi

          PERMIT_TOKEN=$(echo "$JSON" | jq -r '.permit_token // .permit // empty')
          if [ -z "$PERMIT_TOKEN" ] || [ "$PERMIT_TOKEN" = "null" ]; then
            echo "::error::PRIMARY allow but missing permit_token — BLOCKED"
            exit 1
          fi

          echo "permit_token=$PERMIT_TOKEN" >> $GITHUB_OUTPUT

      - name: Verify Permit (PRIMARY — gates)
        env:
          ATLASENT_API_KEY: ${{ secrets.ATLASENT_API_KEY }}
          PERMIT_TOKEN: ${{ steps.primary_eval.outputs.permit_token }}
          REQUEST_ID: ${{ steps.payload.outputs.request_id }}
        run: |
          set -euo pipefail
          : "${ATLASENT_API_KEY:?Missing secret ATLASENT_API_KEY}"
          : "${ATLASENT_ANON_KEY:?Missing variable ATLASENT_ANON_KEY}"

          VERIFY_ID="verify-${REQUEST_ID}"

          BODY=$(jq -nc \
            --arg permit_token "${PERMIT_TOKEN}" \
            --arg action_type "production.deploy" \
            --arg actor_id "github:${GITHUB_ACTOR}" \
            --arg environment "prod" \
            --arg request_id "${VERIFY_ID}" \
            --arg env "prod" \
            --arg repo "${GITHUB_REPOSITORY}" \
            --arg sha "${GITHUB_SHA}" \
            --arg ref "${GITHUB_REF}" \
            --arg run_id "${GITHUB_RUN_ID}" \
            --argjson approvals 2 \
            --argjson change_window true \
            '{
              permit_token: $permit_token,
              action_type: $action_type,
              actor_id: $actor_id,
              environment: $environment,
              request_id: $request_id,
              context: {
                environment: $env,
                approvals: $approvals,
                change_window: $change_window,
                repo: $repo,
                sha: $sha,
                ref: $ref,
                run_id: $run_id
              }
            }')

          RESP=$(curl -sS -i --max-time 30 \
            -X POST "${ATLASENT_PRIMARY_BASE_URL}/v1-verify-permit" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${ATLASENT_API_KEY}" \
            -H "apikey: ${ATLASENT_ANON_KEY}" \
            -d "${BODY}")

          echo "---- PRIMARY VERIFY RAW ----"
          echo "$RESP"
          echo "----------------------------"

          HTTP_CODE=$(echo "$RESP" | head -n 1 | awk '{print $2}')
          if [ "$HTTP_CODE" != "200" ] && [ "$HTTP_CODE" != "201" ] && [ "$HTTP_CODE" != "204" ]; then
            echo "::error::PRIMARY verify HTTP $HTTP_CODE — BLOCKED (fail-closed)"
            exit 1
          fi

          JSON=$(echo "$RESP" | awk 'BEGIN{h=1} /^\r?$/{h=0; next} {if(!h) print}')
          OUTCOME=$(echo "$JSON" | jq -r '.outcome // .decision // empty')

          if [ "$OUTCOME" != "allow" ]; then
            CODE=$(echo "$JSON" | jq -r '.verify_error_code // .deny_code // "unknown"')
            REASON=$(echo "$JSON" | jq -r '.reason // .deny_reason // "unknown"')
            echo "::error::PRIMARY verify failed outcome=$OUTCOME code=$CODE reason=$REASON"
            exit 1
          fi

      # -------------------------
      # SHADOW (NON-GATING) CALL
      # -------------------------
      - name: Evaluate (SHADOW — non-gating)
        continue-on-error: true
        env:
          ATLASENT_API_KEY: ${{ secrets.ATLASENT_API_KEY }}
          BODY: ${{ steps.payload.outputs.body }}
        run: |
          set -euo pipefail
          : "${ATLASENT_ANON_KEY:?Missing variable ATLASENT_ANON_KEY}"

          RESP=$(curl -sS -i --max-time 30 \
            -X POST "${ATLASENT_SHADOW_BASE_URL}/v1-evaluate" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${ATLASENT_API_KEY}" \
            -H "apikey: ${ATLASENT_ANON_KEY}" \
            -d "${BODY}")

          echo "---- SHADOW EVAL RAW ----"
          echo "$RESP"
          echo "-------------------------"

      - name: Deploy to Production (placeholder)
        run: echo "✅ Replace this with your real deploy command"

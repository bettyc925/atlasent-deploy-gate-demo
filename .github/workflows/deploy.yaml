name: AtlaSent Deploy Gate

on:
  push:
    branches: [main]
  workflow_dispatch: {}

env:
  ATLASENT_BASE_URL: https://ducfnmhveikymmgwpgcd.supabase.co/functions/v1
  ATLASENT_ANON_KEY: ${{ vars.ATLASENT_ANON_KEY }}

jobs:
  atlasent-deploy-gate:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install jq (required)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Evaluate (gates deploy)
        id: eval
        env:
          ATLASENT_API_KEY: ${{ secrets.ATLASENT_API_KEY }}
        run: |
          set -euo pipefail
          : "${ATLASENT_API_KEY:?Missing secret ATLASENT_API_KEY}"
          : "${ATLASENT_ANON_KEY:?Missing variable ATLASENT_ANON_KEY (public anon key)}"

          REQUEST_ID="github-eval-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"

          BODY=$(jq -nc \
            --arg action_type "production.deploy" \
            --arg actor_id "github:${GITHUB_ACTOR}" \
            --arg request_id "$REQUEST_ID" \
            --arg env "prod" \
            --arg repo "${GITHUB_REPOSITORY}" \
            --arg sha "${GITHUB_SHA}" \
            --arg ref "${GITHUB_REF}" \
            --arg run_id "${GITHUB_RUN_ID}" \
            --argjson approvals 2 \
            --argjson change_window true \
            '{
              action_type: $action_type,
              actor_id: $actor_id,
              request_id: $request_id,
              context: {
                environment: $env,
                approvals: $approvals,
                change_window: $change_window,
                repo: $repo,
                sha: $sha,
                ref: $ref,
                run_id: $run_id
              }
            }')

          RESP=$(curl -sS -i --max-time 30 \
            -X POST "${ATLASENT_BASE_URL}/v1-evaluate" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${ATLASENT_API_KEY}" \
            -H "apikey: ${ATLASENT_ANON_KEY}" \
            -d "${BODY}")

          echo "---- EVAL RAW RESPONSE ----"
          echo "$RESP"
          echo "---------------------------"

          HTTP_CODE=$(echo "$RESP" | head -n 1 | awk '{print $2}')
          if [ "$HTTP_CODE" != "200" ] && [ "$HTTP_CODE" != "201" ] && [ "$HTTP_CODE" != "204" ]; then
            echo "::error::Evaluate returned HTTP $HTTP_CODE — BLOCKED (fail-closed)"
            exit 1
          fi

          JSON=$(echo "$RESP" | awk 'BEGIN{h=1} /^\r?$/{h=0; next} {if(!h) print}')
          DECISION=$(echo "$JSON" | jq -r '.decision // empty')

          if [ -z "$DECISION" ]; then
            echo "::error::Evaluate missing decision — BLOCKED"
            echo "$JSON" | jq . || true
            exit 1
          fi

          if [ "$DECISION" != "allow" ]; then
            CODE=$(echo "$JSON" | jq -r '.error_code // .deny_code // "unknown"')
            REASON=$(echo "$JSON" | jq -r '.reason // .deny_reason // "no reason provided"')
            echo "::error::BLOCKED by evaluate decision=$DECISION code=$CODE reason=$REASON"
            exit 1
          fi

          PERMIT_TOKEN=$(echo "$JSON" | jq -r '.permit_token // .permit // empty')
          if [ -z "$PERMIT_TOKEN" ] || [ "$PERMIT_TOKEN" = "null" ]; then
            echo "::error::Allowed but missing permit_token — BLOCKED"
            exit 1
          fi

          echo "permit_token=$PERMIT_TOKEN" >> $GITHUB_OUTPUT
          echo "request_id=$REQUEST_ID" >> $GITHUB_OUTPUT

      - name: Verify permit (execution-time enforcement)
        env:
          ATLASENT_API_KEY: ${{ secrets.ATLASENT_API_KEY }}
          PERMIT_TOKEN: ${{ steps.eval.outputs.permit_token }}
          EVAL_REQUEST_ID: ${{ steps.eval.outputs.request_id }}
        run: |
          set -euo pipefail
          : "${ATLASENT_API_KEY:?Missing secret ATLASENT_API_KEY}"
          : "${ATLASENT_ANON_KEY:?Missing variable ATLASENT_ANON_KEY}"
          : "${PERMIT_TOKEN:?Missing permit token from evaluate}"

          VERIFY_ID="verify-${EVAL_REQUEST_ID}"

          BODY=$(jq -nc \
            --arg permit_token "${PERMIT_TOKEN}" \
            --arg action_type "production.deploy" \
            --arg actor_id "github:${GITHUB_ACTOR}" \
            --arg environment "prod" \
            --arg request_id "${VERIFY_ID}" \
            --arg env "prod" \
            --arg repo "${GITHUB_REPOSITORY}" \
            --arg sha "${GITHUB_SHA}" \
            --arg ref "${GITHUB_REF}" \
            --arg run_id "${GITHUB_RUN_ID}" \
            --argjson approvals 2 \
            --argjson change_window true \
            '{
              permit_token: $permit_token,
              action_type: $action_type,
              actor_id: $actor_id,
              environment: $environment,
              request_id: $request_id,
              context: {
                environment: $env,
                approvals: $approvals,
                change_window: $change_window,
                repo: $repo,
                sha: $sha,
                ref: $ref,
                run_id: $run_id
              }
            }')

          RESP=$(curl -sS -i --max-time 30 \
            -X POST "${ATLASENT_BASE_URL}/v1-verify-permit" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${ATLASENT_API_KEY}" \
            -H "apikey: ${ATLASENT_ANON_KEY}" \
            -d "${BODY}")

          echo "---- VERIFY RAW RESPONSE ----"
          echo "$RESP"
          echo "-----------------------------"

          HTTP_CODE=$(echo "$RESP" | head -n 1 | awk '{print $2}')
          if [ "$HTTP_CODE" != "200" ] && [ "$HTTP_CODE" != "201" ] && [ "$HTTP_CODE" != "204" ]; then
            echo "::error::Verify returned HTTP $HTTP_CODE — BLOCKED (fail-closed)"
            exit 1
          fi

          JSON=$(echo "$RESP" | awk 'BEGIN{h=1} /^\r?$/{h=0; next} {if(!h) print}')
          OUTCOME=$(echo "$JSON" | jq -r '.outcome // .decision // empty')
          VALID=$(echo "$JSON" | jq -r '.valid // empty')

          # If API returns valid=false, treat as failure
          if [ -n "$VALID" ] && [ "$VALID" != "true" ]; then
            CODE=$(echo "$JSON" | jq -r '.verify_error_code // .deny_code // "unknown"')
            REASON=$(echo "$JSON" | jq -r '.reason // .deny_reason // "unknown"')
            echo "::error::Permit invalid — code=$CODE reason=$REASON"
            exit 1
          fi

          if [ -z "$OUTCOME" ]; then
            echo "::error::Verify missing outcome/decision — BLOCKED"
            echo "$JSON" | jq . || true
            exit 1
          fi

          if [ "$OUTCOME" != "allow" ]; then
            CODE=$(echo "$JSON" | jq -r '.verify_error_code // .deny_code // "unknown"')
            REASON=$(echo "$JSON" | jq -r '.reason // .deny_reason // "unknown"')
            echo "::error::Permit verification FAILED — outcome=$OUTCOME code=$CODE reason=$REASON"
            exit 1
          fi

          echo "✅ Permit verified — deploy may proceed"

      - name: Deploy to Production (placeholder)
        run: |
          echo "✅ Replace this with your real deploy command"
